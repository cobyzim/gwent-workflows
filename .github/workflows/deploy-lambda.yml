name: Deploy Lambda Snapshot

on:
  workflow_call:
    inputs:
      terragrunt-runner-image:
        description: 'Docker image for Terragrunt runner'
        required: false
        type: string
        default: 'ghcr.io/cobyzim/terragrunt-runner:latest'
      is-snapshot:
        description: 'Whether deploying a snapshot for testing, or a published version'
        required: false
        type: string
        default: 'true'
      role-to-assume:                                                                                                                                                                 
        description: 'ARN of the IAM role to assume via OIDC'                                                                                                                         
        required: true                                                                                                                                                                
        type: string  
    secrets:
      TF_MODULES_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    container:
      image: ${{ inputs.terragrunt-runner-image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root

    defaults:
      run:
        shell: bash

    env:
      HOME: /root

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role-to-assume }}
          aws-region: 'us-east-1'

      - name: Setup SSH for Private Modules
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TF_MODULES_SSH_KEY }}

      - name: Add GitHub to known_hosts                                                                                                                                               
        run: |                                                                                                                                                                        
          mkdir -p /root/.ssh                                                                                                                                                         
          ssh-keyscan github.com >> /root/.ssh/known_hosts 

      - name: Extract Version
        id: version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Check Terraform and Terragrunt Versions
        run: terraform --version && terragrunt --version

      - name: Install Dependencies
        run: |
          apk add --no-cache zip rsync

          echo "Installing Node.js..."                                                                                                                                                
          apk add --no-cache nodejs npm                                                                                                                                               
                                                                                                                                                                                  
          echo "Creating nodejs directory with production deps..."                                                                                                                    
          mkdir -p nodejs                                                                                                                                                             
          cp package.json package-lock.json nodejs/                                                                                                                                   
          cd nodejs && npm ci --omit=dev && cd ..

      - name: Prepare Lambda Layer Artifact
        run: |
          echo "Preparing Lambda Layer zip..."
          FIXED_DATE="1980-01-01 00:00:00"
          mkdir -p artifacts

          LAYER_TMP=$(mktemp -d)
          TMP_DIR="$LAYER_TMP/nodejs"
          mkdir -p "$TMP_DIR"

          rsync -a --delete "./nodejs/" "$TMP_DIR/"
          find "$LAYER_TMP" -type f -exec touch -d "$FIXED_DATE" {} +

          cd "$LAYER_TMP"
          zip -X -r "$OLDPWD/artifacts/layer.zip" nodejs
          cd -
          rm -rf "$LAYER_TMP"

          echo "Layer zip created:"
          ls -lh artifacts/layer.zip

      - name: Prepare Lambda Function Artifact
        run: |
          echo "Preparing Lambda Function zip..."
          FIXED_DATE="1980-01-01 00:00:00"

          FUNC_TMP=$(mktemp -d)
          rsync -a --delete "./src/" "$FUNC_TMP/"
          find "$FUNC_TMP" -type f -exec touch -d "$FIXED_DATE" {} +

          cd "$FUNC_TMP"
          zip -X -r "$OLDPWD/artifacts/function.zip" .
          cd -
          rm -rf "$FUNC_TMP"

          echo "Function zip created:"
          ls -lh artifacts/function.zip

      - name: Deploy with Terragrunt
        working-directory: infrastructure
        env:
          TF_USE_SNAPSHOT: ${{ inputs.is-snapshot }}
          TF_IS_ROLLBACK: 'false'
          TF_APPLICATION_VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Copying artifacts to Terraform directories..."
          cp ../artifacts/layer.zip lambda_layer/
          cp ../artifacts/function.zip lambda_function/

          echo "Applying Terraform with Terragrunt..."
          terragrunt apply -all --non-interactive

          echo "Cleaning up artifacts..."
          rm -f lambda_layer/layer.zip lambda_function/function.zip

          echo "Lambda deployed successfully!"
